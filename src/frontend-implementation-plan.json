{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Fix library save failure for songs and covers",
  "requirements": [
    {
      "id": "REQ-52",
      "summary": "Debug and fix library save mechanism for cover mode by examining handleProcessingComplete callback to identify why songs are not saved after cover processing completes",
      "acceptanceCriteria": [
        "Identify the exact point of failure in the library save workflow for cover mode",
        "Console logs show the complete execution path from processing completion to backend save call",
        "Any errors or exceptions in the save flow are captured and logged"
      ],
      "file_operations": [
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Add comprehensive console logging in handleProcessingComplete callback to track: (1) when the callback is invoked, (2) the coverId parameter value, (3) any errors during navigation to library, and (4) confirmation that setView('library') is executed. Wrap the callback body in try-catch to capture any exceptions."
        },
        {
          "path": "frontend/src/hooks/useProcessingStatus.ts",
          "operation": "modify",
          "description": "Add detailed console logging throughout the useProcessingStatus hook to track: (1) when processing stages begin and complete, (2) the dummy audio blob creation, (3) all parameters passed to actor.createCover (coverId, songId, voiceSampleId, finalMix blob), (4) the backend response or any thrown errors, and (5) when onComplete callback is invoked with the coverId. Add try-catch around the actor.createCover call to log any failures."
        }
      ]
    },
    {
      "id": "REQ-53",
      "summary": "Debug and fix library save mechanism for generation mode by examining handleGenerationComplete callback to identify why songs are not saved after lyrics generation completes",
      "acceptanceCriteria": [
        "Identify the exact point of failure in the library save workflow for generation mode",
        "Console logs show the complete execution path from lyrics submission to backend save call",
        "Any errors or exceptions in the save flow are captured and logged"
      ],
      "file_operations": [
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Add comprehensive console logging in handleGenerationComplete callback to track: (1) when the callback is invoked, (2) the coverId parameter value, (3) any errors during navigation to library, and (4) confirmation that setView('library') is executed. Wrap the callback body in try-catch to capture any exceptions."
        },
        {
          "path": "frontend/src/hooks/useGenerationStatus.ts",
          "operation": "modify",
          "description": "Add detailed console logging throughout the useGenerationStatus hook to track: (1) when generation stages begin and complete, (2) progress updates for each stage, (3) when the simulated generation completes, (4) the requestId being returned, and (5) when onComplete callback is invoked with the coverId/requestId. Note that this hook does not call backend save functions directly - it only simulates progress and returns a generated ID."
        },
        {
          "path": "frontend/src/components/GenerationMode.tsx",
          "operation": "modify",
          "description": "Add console logging to track: (1) when handleSubmit is called with lyrics and style prompt, (2) the generated requestId, (3) all parameters being passed to actor.submitLyricsRequest, (4) the backend response or any errors, and (5) when onSubmit callback is invoked. Add try-catch around the submitLyricsRequest call to capture and log any backend errors."
        }
      ]
    },
    {
      "id": "REQ-54",
      "summary": "Verify that backend createCover function is called with complete and correct parameters from useProcessingStatus hook's final step",
      "acceptanceCriteria": [
        "Backend createCover function receives all required parameters",
        "Function returns a valid cover ID upon successful creation",
        "Any backend errors are properly propagated to the frontend"
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useProcessingStatus.ts",
          "operation": "modify",
          "description": "Add validation logging before calling actor.createCover to verify: (1) coverId is a valid non-empty string, (2) songId is a valid non-empty string, (3) voiceSampleId is a valid non-empty string, (4) finalMix ExternalBlob object exists and has valid data. Log the type and structure of each parameter. Add error handling to catch and log any backend rejection or exception, then re-throw to propagate errors to the caller."
        }
      ]
    },
    {
      "id": "REQ-56",
      "summary": "Add comprehensive console logging throughout App.tsx to track the complete library save workflow including processing completion, data passed to save functions, backend results, and navigation",
      "acceptanceCriteria": [
        "Console logs show exact state at processing completion",
        "Console logs show all parameters being passed to backend save functions",
        "Console logs show backend response (success or error)",
        "Console logs show navigation trigger to library view"
      ],
      "file_operations": [
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Add structured console logging throughout App.tsx to track: (1) component mount and current view state, (2) when handleProcessingComplete is called with coverId parameter, (3) when handleGenerationComplete is called with coverId parameter, (4) when view changes occur via setView, (5) current workflow step and mode state, and (6) persona selection state. Group related logs using console.group for better readability. Add timestamp prefixes to all log statements."
        }
      ]
    },
    {
      "id": "REQ-57",
      "summary": "Ensure automatic navigation to Library view and immediate display of newly created songs after both cover and generation modes complete without page refresh",
      "acceptanceCriteria": [
        "User is automatically navigated to Library view after processing completes",
        "Newly created song appears in the library list immediately",
        "React Query cache is invalidated to refetch library data",
        "No page refresh is required to see the new song"
      ],
      "file_operations": [
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Modify handleProcessingComplete and handleGenerationComplete callbacks to: (1) call queryClient.invalidateQueries for the user library query to force a refetch, (2) add a small delay (100-200ms) before navigation to ensure backend save completes, (3) navigate to library view via setView('library'), and (4) log each step. Import useQueryClient from @tanstack/react-query to access the query client instance."
        },
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Ensure the useUserLibrary hook has appropriate refetchOnMount and staleTime settings to immediately show new data when the Library view is navigated to. Add a query key constant that can be imported by App.tsx for manual invalidation. Consider setting staleTime to 0 or a low value to ensure fresh data is always fetched."
        }
      ]
    },
    {
      "id": "REQ-58",
      "summary": "Add error toast notifications that display user-friendly messages when songs fail to save to the library, including specific error details",
      "acceptanceCriteria": [
        "Toast notification appears when library save fails",
        "Error message is user-friendly and actionable",
        "Technical details are logged to console for debugging"
      ],
      "file_operations": [
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Import and use the toast notification system (likely from shadcn-ui components) to display error messages in handleProcessingComplete and handleGenerationComplete callbacks. Wrap the processing completion logic in try-catch blocks and show user-friendly error toasts on failure such as 'Failed to save your song to the library. Please try again.' while logging the full technical error to console. Include the error message in the toast if it provides actionable information."
        },
        {
          "path": "frontend/src/hooks/useProcessingStatus.ts",
          "operation": "modify",
          "description": "Modify the hook to return error state alongside the progress state. When actor.createCover fails, capture the error and include it in the return value so App.tsx can display appropriate error messages to the user. Do not suppress errors - allow them to propagate while also tracking them in state."
        },
        {
          "path": "frontend/src/components/GenerationMode.tsx",
          "operation": "modify",
          "description": "Add error handling in the handleSubmit function to catch and display user-friendly error messages when actor.submitLyricsRequest fails. Import and use the toast notification system to show errors like 'Failed to submit lyrics request. Please try again.' while logging technical details to console."
        }
      ]
    }
  ]
}